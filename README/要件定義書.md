## otography 要件定義書 (最終版)

### 1. はじめに

本ドキュメントは、Expo、Node.js、Supabaseを用いて開発する音楽系SNSアプリotographyの要件定義書 (最終版) です。主にAPIとバックエンドの設計・実装に焦点を当て、フロントエンドに関する記述は必要最低限に留めます。

### 2. システム概要

#### 2.1 アプリの概要

本アプリは、MusicKitを用いた音楽再生機能、プレイリスト機能を中核に、Twitter風投稿機能(Post)、ブログ機能(Mlog)、日次音楽共有機能(Today)を備えた音楽系SNSです。

#### 2.2 システム構成


* **クライアント:** Expo        
* **APIサーバー:** Node.js
* **データベース:** Supabase
* **外部サービス:** Apple Music API (MusicKit 経由)

#### 2.3 開発環境

* Expo SDK: 最新バージョン
* Node.js: LTSバージョン
* Supabase CLI: 最新バージョン
* データベース: PostgreSQL (Supabase提供)
* その他ライブラリ:
    * MusicKit (Apple Music APIアクセス)
    * TanStack Query/React Query (データフェッチ、キャッシュ、セッション管理)

### 3. 機能要件

#### 3.1 音楽機能

##### 3.1.1 音楽再生

* Apple Musicの楽曲を再生できること
* 再生方式: シャッフル再生、リピート再生、一曲リピート再生、エンドレス再生
* 再生画面、プレイリスト画面はApple Musicのデザインを踏襲
* 歌詞の表示はしない(出来ない)
* MusicKitの機能を利用し、再生履歴、再生キューの管理を行う

##### 3.1.2 プレイリスト

* ユーザーがプレイリストを作成、編集、削除できること
* プレイリストに楽曲を追加、削除、並び替えできること
* プレイリストを公開、非公開設定できること
* 公開プレイリストは他のユーザーがフォローできること

##### 3.1.3 音楽検索

* アーティスト名、曲名、アルバム名で楽曲を検索できること
* MusicKitの検索APIを利用し、検索結果を表示する

##### 3.1.4 音楽情報

* MusicKitのAPIを利用し、楽曲、アーティスト、アルバム情報を表示する
* 楽曲情報: 曲名、アーティスト名、アルバム名、ジャケット画像、再生時間、歌詞など
* アーティスト情報: アーティスト名、プロフィール画像、人気曲、アルバム一覧など
* アルバム情報: アルバム名、アーティスト名、ジャケット画像、収録曲一覧、リリース日など

#### 3.2 Post機能

##### 3.2.1 投稿

* ユーザーが150文字以内のテキストと最大4枚の画像を投稿できること
* 動画の投稿機能は実装しない
* **投稿後の編集はできない**

##### 3.2.2 タイムライン

* 2種類のタイムラインを提供する:
    * おすすめタイムライン: 全投稿から時系列順に表示 (ただし、削除されたユーザーの投稿は表示しない)
    * フォロータイムライン: フォローしているユーザーの投稿を時系列順に表示 (ただし、削除されたユーザーの投稿は表示しない)

##### 3.2.3 いいね・リプライ

* ユーザーが投稿に対して「いいね」できること
* ユーザーが投稿に対してリプライできること
* TanStack Query/React Queryを用いて、「いいね」への連打を防止する

#### 3.3 Mlog機能

##### 3.3.1 記事投稿

* ユーザーが記事(Mlog)を投稿できること
* 記事は文字数制限なし
* HTMLを用いたリッチなテキスト表現が可能
* 画像は無制限に添付可能
* 動画の添付機能は実装しない
* **投稿後の編集が可能**

##### 3.3.2 記事一覧

* 記事のタイトル、サムネイル、投稿日時を表示する
* 記事には4つの属性があり、一覧画面には属性に関わらず全記事を表示する (ただし、削除されたユーザーの投稿は表示しない)
* 属性ごとにDBのテーブルを分割するが、一覧表示に必要な情報は共通テーブルに保存する

##### 3.3.3 記事詳細

* 記事の本文、画像、投稿日時を表示する
* 表示内容は記事の属性によって異なる
* **いいね機能を実装**

#### 3.4 Today機能

##### 3.4.1 投稿

* ユーザーが1日に1回、楽曲と100文字以内のテキストを投稿できること
* **投稿はDBに保持するが、投稿日時から3日経過した投稿はAPIで取得できず、表示されない**
* **投稿後の編集はできない**

##### 3.4.2 一覧表示

* Today投稿のリストを表示する (ただし、削除されたユーザーの投稿、投稿日時から3日経過した投稿は表示しない)
* リストには、ユーザー名、投稿日時、楽曲情報、テキストを表示する

##### 3.4.3 詳細表示

* Today投稿の詳細を表示する (ただし、削除されたユーザーの投稿、投稿日時から3日経過した投稿は表示しない)
* 詳細画面では、スワイプ操作で他の投稿に遷移できる
* **いいね機能を実装**

#### 3.5 アカウント機能

##### 3.5.1 アカウント登録・ログイン

* **ユーザーはAppleとGoogleのOAuth認証を利用してアカウント登録・ログインを行う**
* メールアドレスとパスワードによる登録・ログイン機能は実装しない

##### 3.5.2 プロフィール

* ユーザーはプロフィール情報を設定できること
* プロフィール情報: ユーザー名、プロフィール画像、自己紹介文など
* ユーザーは10組までお気に入りのアーティストを設定できること
* お気に入りアーティストはMusicKitの検索機能を利用して設定できる
* Apple Musicに登録されていないアーティストは、ユーザーが手動で名前を登録できる
* **ユーザーの最新Today投稿が表示される (ただし、投稿日時から3日経過した投稿は表示しない)（これを実装するか議論）**

##### 3.5.3 非公開アカウント

* ユーザーはアカウントを非公開に設定できること
* 非公開アカウントでは、投稿はフォロワーのみに表示される

##### 3.5.4 フォローリクエスト

* 非公開アカウントに対しては、フォローリクエストを送信する必要がある
* フォローリクエストは承認・拒否できる
* フォローリクエスト機能は、フォローテーブルにステータスを追加するか、別途テーブルを作成して実装する

##### 3.5.4 お気に入りアーティスト

* ユーザーがお気に入りのアーティストを登録できること
* MusicKitのAPIを利用し、アーティスト情報を取得、表示する
* Apple Musicに登録されていないアーティストは、ユーザーが手動で登録できること

##### 3.5.5 アカウント削除

* **ユーザーがアカウントを削除した場合、関連する投稿 (Post, Mlog, Today) やいいね、リプライなどのデータは、DBからは削除せず、 `deleted_at` カラムに削除日時を設定して論理削除とする。**

#### 3.6 セッション管理

* **Supabaseのセッション管理機能とTanStack Query/React Queryを用いてセッション管理を行う。JWTを用いたアクセストークンとリフレッシュトークンによる認証を行い、アクセストークンの有効期限切れ時にはリフレッシュトークンを用いて自動的に更新する。**
* 不正なアクセスを防ぐため、APIリクエストには認証情報を付与する
* セッションの有効期限を設定し、期限切れの場合は再ログインを要求する

### 4. データベース設計

#### 4.1 usersテーブル

| カラム名          | データ型     | NULL可否 | 主キー | 外部キー | 説明                                               |
|-------------------|--------------|----------|--------|----------|----------------------------------------------------|
| id               | UUID       | NOT NULL | Yes     |auth.id         | ユーザーID                  
|prfileid          |TEXT        |NOT NULL |         |       |ユーザー側での識別子
| username         | VARCHAR(50)  | NULL     |        |          | ユーザー名                                           |
| profile_image_url | TEXT         | NULL     |        |          | プロフィール画像URL                               |
| bio              | TEXT         | NULL     |        |          | 自己紹介文                         
|following            |INTEGER     |NOT NULL       |       |       |フォロー数
|followed            |INTEGER     |NOT NULL       |       |       |フォロワー数
| is_private       | BOOLEAN      | NOT NULL |        |          | 非公開アカウントフラグ (true: 非公開, false: 公開) |
|created_at     |TIMESTAMPZ     |NOT NULL       |       |       |作成日時
| deleted_at       | TIMESTAMPZ    | NULL     |        |          | 削除日時 (論理削除)                                 |

#### 4.2 postsテーブル

| カラム名       | データ型     | NULL可否 | 主キー | 外部キー | 説明                     |
|----------------|--------------|----------|--------|----------|--------------------------|
| id            | SERIAL       | NOT NULL | Yes     |          | 投稿ID                   |
| user_id       | UUID      | NOT NULL |        | users.id | 投稿ユーザーID           |
| content        | TEXT         | NOT NULL |        |          | 投稿本文                 |
| image_urls    | TEXT[]       | NULL     |        |          | 投稿画像URLの配列         |
| created_at     | TIMESTAMP    | NOT NULL |        |          | 投稿日時                 |
| deleted_at     | TIMESTAMP    | NULL     |        |          | 削除日時 (論理削除)       |
|likes      | INTEGER       |NOT NULL       |       |       |いいね数       |
|views      | INTEGER       |NOT NULL       |       |       |閲覧数

#### 4.3 mlogsテーブル(各属性ごとに作成)

| カラム名       | データ型     | NULL可否 | 主キー | 外部キー | 説明                   |
|----------------|--------------|----------|--------|----------|------------------------|
| id            | SERIAL       | NOT NULL | Yes     | mlog_summriies.mlog_id         | 記事ID                 |
| content        | TEXT         | NOT NULL |        |          | 記事本文               |
| image_urls    | TEXT[]       | NULL     |        |          | 記事画像URLの配列       |
| playlist_id    | TEXT       | NULL     |        | Playlist.playlist_id         | プレイリストの識別子    |

#### 4.4 mlog_summariesテーブル

| カラム名       | データ型     | NULL可否 | 主キー | 外部キー | 説明               |
|----------------|--------------|----------|--------|----------|--------------------|
| mlog_id       | INTEGER      | NOT NULL | Yes     |    | 記事ID             |
| user_id       | UUID      | NOT NULL |        | users.id | 記事投稿ユーザーID       |
| title         | VARCHAR(255) | NOT NULL |        |          | 記事タイトル             |
| thumbnail_url | TEXT         | NOT NULL     |        |          | サムネイル画像URL     |
| info1       | TEXT         | NULL     |        |          | 記事概要(属性ごとに異なる)             |
| info2       | TEXT         | NULL     |        |          | 記事概要(属性ごとに異なる)             |
| Type       | TEXT         | NULL     |        |          | 記事の属性           |
| created_at       | TIMESTAMPZ       | NOT NULL     |        |          | 作成日時           |
| deleted_at     | TIMESTAMP    | NULL     |        |          | 削除日時 (論理削除)       |
|likes      | INTEGER       |NOT NULL       |       |       |いいね数       |
|views      | INTEGER       |NOT NULL       |       |       |閲覧数

#### 4.5 todayテーブル

| カラム名     | データ型    | NULL可否 | 主キー | 外部キー | 説明                   |
|--------------|-------------|----------|--------|----------|------------------------|
| id          | SERIAL      | NOT NULL | Yes     |          | Today投稿ID            |
| user_id     | INTEGER     | NOT NULL |        | users.id | 投稿ユーザーID           |
| music_id    | VARCHAR(255) | NOT NULL |        |          | 楽曲ID                 |
| content      | TEXT        | NOT NULL |        |          | テキスト               |
| created_at   | TIMESTAMP   | NOT NULL |        |          | 投稿日時                 |
| deleted_at   | TIMESTAMP   | NULL     |        |          | 削除日時 (論理削除)       |
|likes      | INTEGER       |NOT NULL       |       |       |いいね数       |
|views      | INTEGER       |NOT NULL       |       |       |閲覧数

#### 4.6 likesテーブル(それぞれで分けましょう)

| カラム名    | データ型 | NULL可否 | 主キー | 外部キー | 説明         |
|-------------|----------|----------|--------|----------|--------------|
| user_id    | INTEGER  | NOT NULL | Yes     | users.id | ユーザーID     |
| target_id  | INTEGER  | NOT NULL | Yes     |          | いいね対象のID (posts.id or mlogs.id or today_posts.id) |
| created_at  | TIMESTAMP | NOT NULL |        |          | いいね日時     |

#### 4.7 repliesテーブル

| カラム名    | データ型 | NULL可否 | 主キー | 外部キー | 説明             |
|-------------|----------|----------|--------|----------|------------------|
| id          | SERIAL  | NOT NULL | Yes     |          | リプライID         |
| user_id    | INTEGER  | NOT NULL |        | users.id | リプライユーザーID |
| post_id    | INTEGER  | NOT NULL |        | posts.id | 対象投稿ID       |
| parent_reply_id | INTEGER  | NULL     |        | replies.id | 親リプライID (リプライに対するリプライの場合) |
| content     | TEXT     | NOT NULL |        |          | リプライ本文       |
| created_at  | TIMESTAMP | NOT NULL |        |          | リプライ日時     |

#### 4.8 followsテーブル

| カラム名       | データ型 | NULL可否 | 主キー | 外部キー | 説明                             |
|----------------|----------|----------|--------|----------|----------------------------------|
| follower_id    | INTEGER  | NOT NULL | Yes     | users.id | フォローしているユーザーのID       |
| following_id   | INTEGER  | NOT NULL | Yes     | users.id | フォローされているユーザーのID     |
| status         | VARCHAR(50) | NOT NULL |         |          | フォローリクエストステータス |
| requested_at  | TIMESTAMP | NULL     |         |          | フォローリクエスト送信日時         |
| approved_at   | TIMESTAMP | NULL     |         |          | フォローリクエスト承認日時         |

#### 4.9 blocksテーブル(RLSで制御)
| カラム名       | データ型 | NULL可否 | 主キー | 外部キー | 説明                             |
|----------------|----------|----------|--------|----------|----------------------------------|
| blocker_id    | INTEGER  | NOT NULL | Yes     | users.id | ブロックしているユーザーのID       |
| blocking_id   | INTEGER  | NOT NULL | Yes     | users.id | ブロックされているユーザーのID     |

### 5. API仕様

#### 5.1 認証API

| メソッド | エンドポイント             | リクエストボディ | レスポンスボディ                 | 説明               |
|---------|-----------------------------|--------------------|----------------------------------|--------------------|
| POST    | /api/auth/apple             | { appleToken }     | { user, token }                   | Appleアカウント連携 |
| POST    | /api/auth/google            | { googleToken }    | { user, token }                   | Googleアカウント連携 |
| POST    | /api/auth/refresh           | { refreshToken }  | { accessToken }                   | トークンリフレッシュ |
| GET     | /api/auth/me                |                    | { user }                          | ログインユーザー情報取得 |
| DELETE  | /api/auth/me                |                    |                                  | アカウント削除       |

#### 5.2 ユーザーAPI

| メソッド | エンドポイント | リクエストボディ | レスポンスボディ | 説明                   |
|---------|-----------------|--------------------|-------------------|------------------------|
| GET     | /api/users/:id   |                    | { user }          | ユーザー情報取得       |
| PUT     | /api/users/:id   | { user }           | { user }          | ユーザー情報更新       |
| GET     | /api/posts?user_id=user_id |                    | { posts }         | ユーザーの投稿一覧取得   |
| GET     | /api/mlogs?user_id=user_id |                    | { mlogs }        | ユーザーの記事一覧取得   |
| GET     | /api/todays?user_id=user_id |               | { today_posts }    | ユーザーのToday投稿一覧取得 |

#### 5.3 投稿API

| メソッド | エンドポイント             | リクエストボディ                | レスポンスボディ | 説明              |
|---------|------------------------------|---------------------------------|-------------------|------------------- |
| POST    | /api/posts                  | { content, image_urls }         | { post }           | 投稿作成          |
| GET     | /api/posts/:id               |                                | { post }           | 投稿詳細取得       |
| PUT     | /api/posts/:id               | { content, image_urls }         | { post }           | 投稿更新          |
| DELETE  | /api/posts/:id               |                                |                   | 投稿削除          |
| POST    | /api/posts/:id/like          |                                |                   | いいね            |
| DELETE  | /api/posts/:id/like          |                                |                   | いいね解除        |
| POST    | /api/posts/:id/replies       | { content, parent_reply_id }    | { reply }          | リプライ作成      |
| GET     | /api/posts/:id/replies       |                                | { replies }        | リプライ一覧取得   |

#### 5.4 MlogAPI

| メソッド | エンドポイント        | リクエストボディ                 | レスポンスボディ | 説明              |
|---------|-------------------------|----------------------------------|-------------------|------------------- |
| POST    | /api/mlogs             | { title, content, image_urls, type } | { mlog }          | 記事投稿          |
| GET     | /api/mlogs             |                                  | { mlogs }         | 記事一覧取得       |
| GET     | /api/mlogs/:id          |                                  | { mlog }          | 記事詳細取得       |
| PUT     | /api/mlogs/:id          | { title, content, image_urls, type } | { mlog }          | 記事更新          |
| DELETE  | /api/mlogs/:id          |                                  |                   | 記事削除          |
| POST    | /api/mlogs/:id/like      |                                |                   | いいね            |
| DELETE  | /api/mlogs/:id/like      |                                |                   | いいね解除        |

#### 5.5 Today投稿API

| メソッド | エンドポイント                | リクエストボディ      | レスポンスボディ | 説明              |
|---------|-----------------------------------|-----------------------|-------------------|------------------- |
| POST    | /api/today_posts               | { music_id, content } | { today_post }    | Today投稿作成      |
| GET     | /api/today_posts               |                       | { today_posts }    | Today投稿一覧取得   |
| GET     | /api/today_posts/:id            |                       | { today_post }    | Today投稿詳細取得   |
| DELETE  | /api/today_posts/:id            |                       |                   | Today投稿削除      |
| POST    | /api/today_posts/:id/like        |                                |                   | いいね            |
| DELETE  | /api/today_posts/:id/like        |                                |                   | いいね解除        |

#### 5.6 フォローAPI

| メソッド | エンドポイント                  | リクエストボディ | レスポンスボディ | 説明                       |
|---------|-----------------------------------|--------------------|-------------------|----------------------------|
| POST    | /api/users/:id/follow             |                    |                   | フォローリクエスト送信       |
| POST    | /api/users/:id/follow/:follower_id |                    |                   | フォローリクエスト承認       |
| DELETE  | /api/users/:id/follow/:follower_id |                    |                   | フォローリクエスト拒否       |
| DELETE  | /api/users/:id/follow             |                    |                   | フォロー解除                 |


### 6. その他

* **API用語説明**
    * **メソッド**: HTTPメソッド。APIリクエストの種類を表す。
        * GET: データ取得
        * POST: データ作成
        * PUT: データ更新
        * DELETE: データ削除
    * **エンドポイント**: APIにアクセスするためのURL
    * **リクエストボディ**: APIに送信するデータ
    * **レスポンスボディ**: APIから返されるデータ

* **Today投稿の表示制御**

    Today投稿は、投稿日時から3日経過したものはAPIから取得できないようにすることで、表示されないようにします。 具体的には、Today投稿一覧取得API、Today投稿詳細取得APIにおいて、リクエスト時に現在時刻を取得し、投稿日時が3日以上前のデータはレスポンスに含めないようにします。

* **削除されたユーザーの投稿の非表示化**

    ユーザーがアカウントを削除した場合、関連する投稿 (Post, Mlog, Today) は `deleted_at` カラムに削除日時を設定して論理削除とします。  APIでは、削除されたデータは取得しないようにすることで、削除されたユーザーの投稿は表示されなくなります。

## 運用体制、セキュリティ要件、パフォーマンス要件について

以下は一般的な音楽系SNSアプリにおける、運用体制、セキュリティ要件、パフォーマンス要件の例です。

**運用体制**

* **監視**:
    * **システムリソース監視**: CPU使用率、メモリ使用率、ディスク使用量などを監視し、システムリソースの不足を検知する。
    * **アプリケーションパフォーマンス監視**: APIのレスポンスタイム、エラー発生率などを監視し、アプリケーションのパフォーマンス低下を検知する。
    * **セキュリティ監視**: 不正アクセスや攻撃の兆候を検知する。
* **障害対応**:
    * 障害発生時の対応手順を定義し、迅速な復旧体制を構築する。
    * 障害発生時に備え、定期的なバックアップと復旧訓練を実施する。
* **パフォーマンスチューニング**:
    * アプリケーションのパフォーマンスを継続的に監視し、ボトルネックを特定して改善する。
    * データベースのクエリチューニングやキャッシュの利用など、パフォーマンス向上のための施策を実施する。
* **バージョンアップ**:
    * アプリケーションやミドルウェアのバージョンアップを定期的に実施し、セキュリティ脆弱性を解消する。
    * バージョンアップによる影響を最小限に抑えるため、事前に十分なテストを実施する。

**セキュリティ要件**

* **認証・認可**:
    * OAuthによる厳密なユーザー認証を行い、不正アクセスを防止する。
    * アクセス権限を適切に設定し、権限のないユーザーによる操作を制限する。
* **通信の暗号化**:
    * HTTPS通信を利用し、通信内容の盗聴や改ざんを防止する。
* **入力値検証**:
    * クロスサイトスクリプティングやSQLインジェクションなどの脆弱性を防ぐため、ユーザーからの入力値を適切に検証する。
* **個人情報保護**:
    * 個人情報を含むデータは適切に暗号化し、セキュリティレベルの高い環境で保管する。
    * 個人情報へのアクセスは必要最小限に制限し、アクセスログを記録する。

**パフォーマンス要件**

* **応答速度**:
    * APIのレスポンスタイムは、ユーザーがストレスなく操作できる範囲に抑える。
    * 特に、アクセスが集中する時間帯や機能については、十分なパフォーマンスを確保する。
* **処理能力**:
    * 想定されるユーザー数やアクセス頻度を考慮し、十分な処理能力を備えたシステムを構築する。
    * ユーザー数の増加に応じて、スケールアウトやスケールアップなどの対応を行う。
* **安定稼働**:
    * 安定稼働を実現するために、システムリソースに余裕を持たせた設計を行う。
    * 障害発生時にも、サービス全体への影響を最小限に抑えるための対策を講じる。
